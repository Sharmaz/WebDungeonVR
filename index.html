<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Web Dungeon VR</title>
    <meta name="description" content="Hello, World! - A-Frame">
    <script src="https://aframe.io/releases/0.6.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v3.8.6/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.rawgit.com/ngokevin/kframe/0d22a890/components/sun-sky/dist/aframe-sun-sky.min.js"></script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <a-scene fog="type: exponential; color: #2A324C; density: 0.4;">
      <a-assets>
        <img src="assets/suelo2.jpg" id="suelo">
        <img src="assets/pared.jpg" id="pared">
        <img src="assets/HUD_0.png" id="hud0">
        <img src="assets/HUD_1.png" id="hud1">
        <img src="assets/HUD_2.png" id="hud2">
        <img src="assets/HUD_3.png" id="hud3">
        <img src="assets/HUD_4.png" id="hud4">
        <img src="assets/HUD_5.png" id="hud5">
        <img src="assets/Objective.png" id="objective">
        <img src="assets/Win.png" id="winner">
        <a-asset-item id="llave" src="assets/key/devils-key.dae">
        </a-asset-item>
      </a-assets>
      <a-entity id="jugador" camera universal-controls position="0 1.6 0" rotation="0 90 0" kinematic-body> 
        <a-cursor postion="0 0 -1" fuse="true" fuse-timeout="800"
        geometry="primitive: ring; radiusOuter: 0.033; radiusInner: 0.020;"  material="color: #f6ce30; shader: flat"> </a-cursor>
        <a-text id="score" value="" width="4" color="black" font="mozillavr" position="0 -.5 -1" anchor="center" align="center"></a-text>
        <a-image id="hud" src="#hud0" position="0 0.5 -0.8" width="2" height="0.1" visible="false"></a-image>
        <a-image id="mission" src="#objective" position="0 0 -0.8" width="2" height="0.24" visible="false"></a-image>
        <a-image id="win" src="#winner" position="0 0 -0.8" width="1" height="0.24" visible="false"></a-image>
      </a-entity>
      <a-entity id="muros">
      </a-entity>
      <a-entity id="premios">
      </a-entity>
      <a-sun-sky material="sunPosition: 0 0 0"></a-sun-sky>
      <a-grid src="#suelo" static-body></a-grid>
      <a-box position="0 4 -7.5" width="50" depth="50" height="0.2" material="src: #suelo; repeat: 50 50"></a-box>
        
    </a-scene>
    <script>

      var mapa = [
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0],
        [1, 0, 0, 0, 1, 3, 0, 0, 0, 1, 0],
        [1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0],
        [1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0],
        [1, 0, 1, 1, 3, 0, 0, 1, 0, 1, 0],
        [1, 0, 0, 0, 1, 1, 1, 1, 3, 1, 0],
        [1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0],
        [1, 3, 1, 0, 1, 2, 1, 3, 1, 0, 0],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0]
      ]

      var tamanoPared = 5
      var altoPared = 4
      var muro, premio
      var muros = document.querySelector('#muros')
      var premios = document.querySelector('#premios')
      var hud = document.querySelector('#hud')
      var mission = document.querySelector('#mission')
      var win = document.querySelector('#win')

      for (var x = 0; x < mapa.length; x++) {
          for (var y = 0; y < mapa[x].length; y++) {

              var posicion = (x - mapa.length/2) * tamanoPared + ' ' + 1.5 + ' ' + (y - mapa[x].length/2) * tamanoPared;

              if (mapa[x][y] == 0) {
                  continue
              } 
              else if (mapa[x][y] == 1) {
                  //Pared
                  muro = document.createElement('a-box')
                  muros.appendChild(muro)
                  muro.setAttribute('color', '#fff')
                  muro.setAttribute('material', 'src: #pared; repeat: 5 2.5;')
                  muro.setAttribute('width', tamanoPared)
                  muro.setAttribute('depth', tamanoPared)
                  muro.setAttribute('height', altoPared)
                  muro.setAttribute('position', posicion)
                  muro.setAttribute('static-body', '')

              }
              else if (mapa[x][y] == 2 ) {
                  //Jugador
                  document.querySelector('#jugador').setAttribute('position', posicion)
              }
              else if (mapa[x][y] == 3 ) {
                  //Premio
                  premio = document.createElement('a-entity')
                  premioAnimation = document.createElement('a-animation')
                  premios.appendChild(premio)
                  premio.setAttribute('position', posicion)
                  premio.setAttribute('class', 'premio')
                  premio.setAttribute('collada-model', '#llave')
                  premio.setAttribute('scale', '2 2 2')
                  premio.appendChild(premioAnimation)
                  
                  premioAnimation.setAttribute('attribute', 'rotation')
                  premioAnimation.setAttribute('from', '0 -30 0')
                  premioAnimation.setAttribute('to', '0 330 0')
                  premioAnimation.setAttribute('dur', '8000')
                  premioAnimation.setAttribute('easing', 'linear')
                  premioAnimation.setAttribute('repeat', 'indefinite')
              }
          }
      }
      var arregloPremios = Array.from(document.querySelectorAll('.premio'))
      var score = arregloPremios.length
      var scoreToWin = 0

      document.querySelector('a-scene').addEventListener('exit-vr', function () {
        hud.setAttribute('visible', 'false')
        mission.setAttribute('visible', 'false')
        win.setAttribute('visible', 'false')
      })
        
      
      document.querySelector('a-scene').addEventListener('enter-vr',
        function () {

          hud.setAttribute('visible', 'true')
          mission.setAttribute('visible', 'true')

          setTimeout(function(){ mission.setAttribute('visible', 'false') }, 5000)

          arregloPremios.forEach(function(premio) {
            premio.addEventListener('click', function() {
              premio.setAttribute('visible', 'false')
              score--
              scoreToWin++

              if (score <= 0) {
                win.setAttribute('visible', 'true')
                setTimeout(function(){ document.querySelector('a-scene').exitVR()
                  ;}, 5000)
                setTimeout(function(){ 
                  window.location.href = '/';
                  }, 6000)
              }
              if (scoreToWin == 1) {
                hud.setAttribute('src', '#hud1')
              } else if (scoreToWin == 2) {
                hud.setAttribute('src', '#hud2')
              } else if (scoreToWin == 3) {
                hud.setAttribute('src', '#hud3')
              } else if (scoreToWin == 4) {
                hud.setAttribute('src', '#hud4')
              } else if (scoreToWin == 5) {
                hud.setAttribute('src', '#hud5')
              }
            })
          })
        })
    </script>
  </body>
</html>
